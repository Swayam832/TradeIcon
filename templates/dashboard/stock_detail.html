{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ stock.symbol }} - TradeIcon{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ stock.symbol }} - {{ stock.name }}</h5>
                <div>
                    {% if in_watchlist %}
                        <button class="btn btn-sm btn-warning remove-from-watchlist" data-symbol="{{ stock.symbol }}">
                            <i class="fas fa-star me-1"></i> Remove from Watchlist
                        </button>
                    {% else %}
                        <button class="btn btn-sm btn-outline-warning add-to-watchlist" data-symbol="{{ stock.symbol }}">
                            <i class="far fa-star me-1"></i> Add to Watchlist
                        </button>
                    {% endif %}
                    
                    <a href="{% url 'dashboard:strategy_with_symbol' stock.symbol %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-chess me-1"></i> Strategy
                    </a>
                    
                    <a href="{% url 'dashboard:prediction_with_symbol' stock.symbol %}" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-chart-line me-1"></i> Prediction
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h2>${{ stock.current_price|floatformat:2 }}</h2>
                        <h5 class="{% if stock.change >= 0 %}positive{% else %}negative{% endif %}">
                            {{ stock.change|floatformat:2 }} ({{ stock.change_percent|floatformat:2 }}%)
                        </h5>
                    </div>
                    <div class="col-md-6 text-end">
                        {% if in_portfolio %}
                            <button class="btn btn-danger sell-stock" data-symbol="{{ stock.symbol }}">
                                <i class="fas fa-arrow-down me-1"></i> Sell
                            </button>
                        {% else %}
                            <button class="btn btn-success buy-stock" data-symbol="{{ stock.symbol }}">
                                <i class="fas fa-arrow-up me-1"></i> Buy
                            </button>
                        {% endif %}
                    </div>
                </div>
                
                <div class="chart-container" style="position: relative; height:400px;">
                    <canvas id="priceChart"></canvas>
                </div>
                
                <div class="btn-group mt-3" role="group">
                    <button type="button" class="btn btn-outline-secondary time-range" data-range="1d">1D</button>
                    <button type="button" class="btn btn-outline-secondary time-range" data-range="1w">1W</button>
                    <button type="button" class="btn btn-outline-secondary time-range" data-range="1m">1M</button>
                    <button type="button" class="btn btn-outline-secondary time-range" data-range="3m">3M</button>
                    <button type="button" class="btn btn-outline-secondary time-range active" data-range="1y">1Y</button>
                    <button type="button" class="btn btn-outline-secondary time-range" data-range="5y">5Y</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Stock Information</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Symbol</th>
                            <td>{{ stock.symbol }}</td>
                        </tr>
                        <tr>
                            <th>Name</th>
                            <td>{{ stock.name }}</td>
                        </tr>
                        <tr>
                            <th>Current Price</th>
                            <td>${{ stock.current_price|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <th>Change</th>
                            <td class="{% if stock.change >= 0 %}positive{% else %}negative{% endif %}">
                                {{ stock.change|floatformat:2 }} ({{ stock.change_percent|floatformat:2 }}%)
                            </td>
                        </tr>
                        <tr>
                            <th>Last Updated</th>
                            <td>{{ stock.updated_at|date:"F j, Y H:i" }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Related News</h5>
            </div>
            <div class="card-body">
                {% if stock_news %}
                    {% for news in stock_news %}
                        <div class="mb-3">
                            <h6><a href="{{ news.url }}" target="_blank">{{ news.title }}</a></h6>
                            <p class="mb-1">{{ news.content|truncatechars:100 }}</p>
                            <small class="text-muted">{{ news.source }} - {{ news.published_at|date:"F j, Y" }}</small>
                        </div>
                        {% if not forloop.last %}<hr>{% endif %}
                    {% endfor %}
                {% else %}
                    <p>No recent news for {{ stock.symbol }}.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Buy Modal -->
<div class="modal fade" id="buyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Buy {{ stock.symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="buyForm">
                    <div class="mb-3">
                        <label for="buyQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="buyQuantity" min="1" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="buyPrice" class="form-label">Price</label>
                        <input type="number" class="form-control" id="buyPrice" value="{{ stock.current_price }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="buyTotal" class="form-label">Total</label>
                        <input type="text" class="form-control" id="buyTotal" value="${{ stock.current_price }}" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmBuy">Buy</button>
            </div>
        </div>
    </div>
</div>

<!-- Sell Modal -->
<div class="modal fade" id="sellModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sell {{ stock.symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sellForm">
                    <div class="mb-3">
                        <label for="sellQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="sellQuantity" min="1" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="sellPrice" class="form-label">Price</label>
                        <input type="number" class="form-control" id="sellPrice" value="{{ stock.current_price }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="sellTotal" class="form-label">Total</label>
                        <input type="text" class="form-control" id="sellTotal" value="${{ stock.current_price }}" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmSell">Sell</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Price chart
        var ctx = document.getElementById('priceChart').getContext('2d');
        var priceChart;
        
        // Fetch stock data
        function fetchStockData(range = '1y') {
            fetch(`/api/stock/{{ stock.symbol }}/?range=${range}`)
                .then(response => response.json())
                .then(data => {
                    updateChart(data.historical_data);
                })
                .catch(error => console.error('Error fetching stock data:', error));
        }
        
        // Update chart with new data
        function updateChart(data) {
            if (priceChart) {
                priceChart.destroy();
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: '{{ stock.symbol }} Price',
                        data: data.close,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                borderDash: [2, 5]
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initial data load
        fetchStockData();
        
        // Time range buttons
        document.querySelectorAll('.time-range').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.time-range').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                fetchStockData(this.dataset.range);
            });
        });
        
        // Buy button
        document.querySelector('.buy-stock').addEventListener('click', function() {
            var buyModal = new bootstrap.Modal(document.getElementById('buyModal'));
            buyModal.show();
        });
        
        // Sell button
        document.querySelector('.sell-stock')?.addEventListener('click', function() {
            var sellModal = new bootstrap.Modal(document.getElementById('sellModal'));
            sellModal.show();
        });
        
        // Calculate buy total
        document.getElementById('buyQuantity').addEventListener('input', function() {
            var quantity = parseInt(this.value) || 0;
            var price = parseFloat(document.getElementById('buyPrice').value) || 0;
            document.getElementById('buyTotal').value = '$' + (quantity * price).toFixed(2);
        });
        
        // Calculate sell total
        document.getElementById('sellQuantity').addEventListener('input', function() {
            var quantity = parseInt(this.value) || 0;
            var price = parseFloat(document.getElementById('sellPrice').value) || 0;
            document.getElementById('sellTotal').value = '$' + (quantity * price).toFixed(2);
        });
        
        // Confirm buy
        document.getElementById('confirmBuy').addEventListener('click', function() {
            var quantity = parseInt(document.getElementById('buyQuantity').value) || 0;
            var price = parseFloat(document.getElementById('buyPrice').value) || 0;
            
            if (quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            fetch('/api/portfolio/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    symbol: '{{ stock.symbol }}',
                    quantity: quantity,
                    buy_price: price
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Stock purchased successfully!');
                    location.reload();
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error buying stock:', error);
                alert('An error occurred while buying the stock.');
            });
            
            var buyModal = bootstrap.Modal.getInstance(document.getElementById('buyModal'));
            buyModal.hide();
        });
        
        // Confirm sell
        document.getElementById('confirmSell').addEventListener('click', function() {
            // Similar implementation to buy, but with sell endpoint
            alert('Sell functionality will be implemented here');
            var sellModal = bootstrap.Modal.getInstance(document.getElementById('sellModal'));
            sellModal.hide();
        });
        
        // Add to watchlist
        document.querySelector('.add-to-watchlist')?.addEventListener('click', function() {
            fetch('/api/watchlist/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: 'Default',
                    symbols: ['{{ stock.symbol }}']
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Stock added to watchlist!');
                    location.reload();
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error adding to watchlist:', error);
                alert('An error occurred while adding to watchlist.');
            });
        });
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}